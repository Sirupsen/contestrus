<% scheme = {
    'http://'  => <<-CONF,
listen 80;
    CONF
    'https://' => <<-CONF
ssl_certificate #{ENV['APP_SSL_CERT']};
ssl_certificate_key #{ENV['APP_SSL_CERT_KEY']};
listen 443 ssl;
    CONF
} %>

server {
  <%= scheme['http://'] %>

  location / {
    rewrite ^/(.*)$ <%= ENV['APP_SCHEME'] + ENV['APP_HOST'] %>/$1;
  }
}

<% if ENV['APP_SCHEME'] == 'https://' %>
server {
  <%= scheme['https://'] %>

  server_name www.<%= ENV['APP_HOST'] %>;

  location / {
    rewrite ^/(.*)$ <%= ENV['APP_SCHEME'] + ENV['APP_HOST'] %>/$1;
  }
}
<% end %>

server {
  <%= scheme[ENV['APP_SCHEME']] %>

  server_name <%= ENV['APP_HOST'] %>;
  root <%= ENV['APP_ROOT'] %>/public;

  error_log <%= ENV['NGINX_ERROR_LOG'] %>;

  error_page 404 /404.html;
  error_page 500 /500.html;

  location / {
    proxy_pass http://<%= ENV['APP_BIND'] %>;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header Host $host;
    proxy_buffering off;
  }
}

#!/bin/bash

cd "$(dirname "$0")/.."

rm -f bin/*

echo "Bundling"

bundle install --path ./vendor/bundle --standalone --clean --binstubs --quiet

RUBY_BIN="$(ruby -e 'puts Gem.ruby')"

for bin in bin/*; do
  load="$(tail -n1 "$bin")"
  echo "#!$RUBY_BIN" > "$bin"
  echo '$:.unshift File.expand_path("../vendor/lib", __dir__)' >> "$bin"
  echo "$load" >> "$bin"
done

for script in script/*; do
  bin="bin/${script##*/}"
  echo '#!/bin/bash' > "$bin"
  if head -n1 "$script" | grep -q ruby; then
    echo 'cd "$(dirname "$0")/.."' >> "$bin"
    echo "exec bin/ruby $script \"\$@\"" >> "$bin"
  else
    echo "exec $script \"\$@\"" >> "$bin"
  fi
  chmod +x "$bin"
done

ln -sf "$RUBY_BIN" bin/ruby

rm -rf vendor/lib
mkdir vendor/lib

echo "Flattening load path"

bin/ruby -rfileutils <<RUBY
  LOAD_PATH_BEFORE = $:.dup
  require "./vendor/bundle/bundler/setup"
  ($: - LOAD_PATH_BEFORE).each do |load_path|
    Dir["#{load_path}/*"].each do |file|
      FileUtils.cp_r(file, "vendor/lib/")
    end
  end
RUBY

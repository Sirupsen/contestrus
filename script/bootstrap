#!/bin/bash

cd "$(dirname "$0")/.."

rm -f bin/*

bundle install --path ./vendor/bundle --standalone --clean --binstubs --quiet

export RUBY_BIN="$(ruby -e 'puts Gem.ruby')"

perl -pi -e 's/^#!.*$/#!$ENV{RUBY_BIN} --disable-gem/g' bin/*

for script in script/*; do
  bin="bin/${script##*/}"
  echo '#!/bin/bash' > "$bin"
  if head -n1 "$script" | grep -q ruby; then
    echo 'cd "$(dirname "$0")/.."' >> "$bin"
    echo "exec bin/ruby $script \"\$@\"" >> "$bin"
  else
    echo "exec $script \"\$@\"" >> "$bin"
  fi
  chmod +x "$bin"
done

ln -sf "$RUBY_BIN" bin/ruby

rm -rf vendor/environment vendor/lib

#!/bin/bash

set -x

if [ "$#" = "0" ]; then
  echo "Usage: script/provision [user:]host"
  echo
  echo "Provisions a new production Contestrus server."
  exit 1
fi

USER_HOST=$1
HOST="`echo $USER_HOST | cut -d':' -f2`"

FILES="script/provision-basic script/provision-production config/production.sh"

if [ -f "$HOME/.ssh/id_rsa.pub" ]; then
  FILES="$FILES $HOME/.ssh/id_rsa.pub"
fi

if [ ! -f config/production.sh ]; then
  sed "s/APP_HOST=.*/APP_HOST=$HOST/" config/production.sh.sample > config/production.sh
fi

scp $FILES "$USER_HOST":
ssh "$USER_HOST" ENV_CONFIG_PATH=production.sh sudo ./provision-production
